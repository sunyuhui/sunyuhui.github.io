<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>客户端渲染和服务端渲染详细执行流程 | 孙宇辉</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">客户端渲染和服务端渲染详细执行流程</h1><a id="logo" href="/.">孙宇辉</a><p class="description">喜欢纯粹，终生学习者</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">客户端渲染和服务端渲染详细执行流程</h1><div class="post-meta">Mar 24, 2018<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2018/03/24/ssr-and-scr/" href="/2018/03/24/ssr-and-scr/#comments" class="ds-thread-count"></a><div class="post-content"><p>很早之前我就看过一些描述 SSR (server side render) 与 CSR (client side render)的文章，但在我自己去实现一套 SSR  以及将 SSR 与 CSR 作对比之前，我都没有深刻理解其中的区别，这里将以 Vue 为例，进行详细描述。</p>
<h3 id="客户端渲染"><a href="#客户端渲染" class="headerlink" title="客户端渲染"></a>客户端渲染</h3><p>CSR 是大家在使用 Vue 时最常用到的方式，Node 层可加可不加，也可以直接把打包后的文件扔到服务器上，通常使用 Webpack 打包之后的一个典型页面是这样的</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"//path/to/app.***.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">scr</span>=<span class="string">"//path/to/manifest.***.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">scr</span>=<span class="string">"//path/to/vendor.***.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">scr</span>=<span class="string">"//path/to/app.***.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="为什么首屏慢？"><a href="#为什么首屏慢？" class="headerlink" title="为什么首屏慢？"></a>为什么首屏慢？</h4><p>在上面的例子中，浏览器在执行完 <code>app.***.js</code> 之前，,页面会一直显示空白，因为<code>app.***.js</code>里是你所有的业务代码，包括 Vue 整个的实例化过程，其中就包括 <strong>挂载(mounted)</strong>，而在没有挂载之前， id 为 <code>app</code> 的 Div 里是没有任何元素的。</p>
<p>所以在 <code>manifest.***.js</code> , <code>vendor.***.js</code>, <code>app.***.js</code> 这三个文件下载执行完之前，页面都会空白，这才导致白屏长，首屏慢，通常的做法是在 <code>&lt;div id=&quot;app&quot;&gt; &lt;/div</code> 之前加一段 <strong>Loading</strong>，然后在获取到需要呈现的数据，条件”成熟”的时候（比如mounted）再去掉<strong>Loading</strong>，这样至少用户看上去不是白屏，但是首屏长的问题还是没法解决。</p>
<p>这里多说一句，将 <strong>Loading</strong> 加在 id 为 <code>app</code> 的元素里面反而更省事，因为 Vue 在第一次将生成好的 DOM 元素插入到 <code>app</code> 里的时候，是使用 <code>innerHTML</code> 的方式。</p>
<h3 id="服务端渲染"><a href="#服务端渲染" class="headerlink" title="服务端渲染"></a>服务端渲染</h3><p>SSR 是在 Vue2.0之后引入的，Node层是必须的。</p>
<h4 id="首屏问题是如何被解决的"><a href="#首屏问题是如何被解决的" class="headerlink" title="首屏问题是如何被解决的"></a>首屏问题是如何被解决的</h4><p>在 CSR 中，服务端返回的初始内容中，<code>div#app</code>的内容为空，而在 SSR 中，返回的<code>div#app</code>元素里却是不为空的，<a href="https://ssr.vuejs.org/zh/data.html" target="_blank" rel="noopener">官网文档</a>称之为 <strong>快照</strong>，是怎么回事呢？举个例子</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--vue-ssr-outlet--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div&gt;</span><br><span class="line">	&lt;span&gt;&#123;&#123;msg&#125;&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">	&lt;/</span>div&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过上面的模板以及组件，通过 <code>vue-server-renderer</code> 编译之后，从Node端返回的HTML是这样的</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"//path/to/app.***.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span> <span class="attr">data-server-rendered</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">span</span>&gt;</span>this is msg<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">scr</span>=<span class="string">"//path/to/manifest.***.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">scr</span>=<span class="string">"//path/to/vendor.***.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">scr</span>=<span class="string">"//path/to/app.***.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样的内容输出到客户端来，不必等到页面中的JS文件加载执行完，<code>div#app</code>里也有内容,这才解决了首屏问题。</p>
<p>如果上面的 <code>span</code> 是一个输入框等随着用户操作而改变的元素，那此时的内容只是该元素变化过程中的一个临时状态，这就是 <strong>快照</strong> 的含义。</p>
<p>当然了，需要等到页面所有JS加载执行完，完成激活、挂载的操作，该元素才会变成随数据变化而变化的响应式元素。</p>
<h4 id="服务端计算能力"><a href="#服务端计算能力" class="headerlink" title="服务端计算能力"></a>服务端计算能力</h4><p>CSR中，Vue的实例化、挂载都在用户侧浏览器(webview)里，作为天然的“分布式服务”，是不会有计算能力这个问题的，但是在SSR中，客户端只负责Vue实例的激活和挂载，而Vue实例是在服务端生成的，实例化过程中，需要生成 <code>Virtual Dom</code>，这一步是非常消耗计算能力的，所以对于那些PV千万甚至上亿的服务来说，如果使用SSR，那Node服务器的CPU使用率，以及随之带来的时间消耗是需要特别注意的。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://sunyuhui.com/2018/03/24/ssr-and-scr/" data-id="ckbrho44n001q6gzhe0b2n9c2" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Front-End/">Front-End</a></div><div class="post-nav"><a href="/2018/09/01/the-best/" class="pre">最优秀的选手不是培养出来的</a><a href="/2018/01/19/reading-in-my-life/" class="next">阅读于我而言</a></div><div data-thread-key="2018/03/24/ssr-and-scr/" data-title="客户端渲染和服务端渲染详细执行流程" data-url="https://sunyuhui.com/2018/03/24/ssr-and-scr/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2018/03/24/ssr-and-scr/" data-title="客户端渲染和服务端渲染详细执行流程" data-url="https://sunyuhui.com/2018/03/24/ssr-and-scr/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Life/" style="font-size: 15px;">Life</a> <a href="/tags/Work/" style="font-size: 15px;">Work</a> <a href="/tags/Front-End/" style="font-size: 15px;">Front-End</a> <a href="/tags/Fund/" style="font-size: 15px;">Fund</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/06/23/fund_20200623/">基金复盘：20200623</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/13/five-years/">毕业5年了</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/06/2019/">2019年终总结：常识与逻辑</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/13/27-happy-birthday/">27了：所谓生活</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/13/recovery/">所谓自我恢复</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/19/one/">挺想买个保险的</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/21/the-diffrent-between/">人与人的不同</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/17/my-love/">我所需要的</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/09/the-mission-of-life/">使命型人生</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/10/memory/">Memory</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.97md.net/" title="Flying-Pig - 赵兴" target="_blank">Flying-Pig - 赵兴</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© yuhui Sun 2014-2018 All Rights Reserved</div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'sunyuhui'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>